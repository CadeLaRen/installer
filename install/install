#!/bin/sh


run () {
	docker run --rm -it -v "/:/host" svendowideit/installer:$@
}

run ucp install

echo "load_balancer_https_port: 8443" >> /usr/local/etc/dtr/hub.yml

echo "PRE"

run dtr install || true

echo "POST"
# the dtr install will fail, so we need to fix the conflicts and re-run
#run dtr set-admin-port 8443
/ # grep -r 443 /usr/local/etc/dtr/
#/usr/local/etc/dtr/generatedConfigs/nginx.conf:      return 301 https://$host:443$request_uri;
#/usr/local/etc/dtr/generatedConfigs/nginx.conf:    listen 443 default ssl;
#/usr/local/etc/dtr/generatedConfigs/stacker.yml:      443: 443
#/usr/local/etc/dtr/hub.yml:load_balancer_https_port: 443
sed -i~ 's/load_balancer_https_port:.*/load_balancer_https_port: 8443/g' /usr/local/etc/dtr/hub.yml
# TODO: can't remember the other setting needed
run dtr install

run ldap install
run ldapui install
