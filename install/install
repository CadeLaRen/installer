#!/bin/sh


run () {
	docker pull svendowideit/installer:$1
	docker run --rm -it -v "/:/host" svendowideit/installer:$@
}

run ucp install

#mkdir -p /usr/local/etc/dtr/
#echo "load_balancer_https_port: 8443" >> /usr/local/etc/dtr/hub.yml

echo "====== default DTR install"

run dtr install || true

# the dtr install will fail, so we need to fix the conflicts and re-run
# move the sed hack into a dtr set command
#run dtr set-admin-port 8443
/ # grep -r 443 /usr/local/etc/dtr/
#/usr/local/etc/dtr/generatedConfigs/nginx.conf:      return 301 https://$host:443$request_uri;
#/usr/local/etc/dtr/generatedConfigs/nginx.conf:    listen 443 default ssl;
#/usr/local/etc/dtr/generatedConfigs/stacker.yml:      443: 443
#/usr/local/etc/dtr/hub.yml:load_balancer_https_port: 443
sed -i~ 's/load_balancer_https_port:.*/load_balancer_https_port: 8443/g' /usr/local/etc/dtr/hub.yml
rm -r /usr/local/etc/dtr/generatedConfigs/
echo "====== rerun DTR install with https port change"
run dtr install

#run ldap install
#run ldapui install
